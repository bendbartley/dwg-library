<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DWG Library Viewer (Worker + R2 + Requests)</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161c;
      --text:#e7edf3; --muted:#9aa7b4; --accent:#6ee7ff; --bad:#ff6e6e;
      --border:#243040;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#080a0d,#0b0d10 30%,#07090b);
      color:var(--text);
    }
    header{
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(18,22,28,.9);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(6px);
    }
    header .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    h1{font-size:16px;margin:0;font-weight:650;letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12px}
    .wrap{display:grid; grid-template-columns: 380px 1fr; min-height: calc(100vh - 66px);}
    .left{border-right:1px solid var(--border); background:rgba(18,22,28,.65);}
    .right{background:rgba(10,12,15,.4);}
    .pane{padding:14px;}
    .card{
      background:linear-gradient(180deg, rgba(18,22,28,.9), rgba(15,19,24,.9));
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .stack{display:flex; flex-direction:column; gap:10px;}
    input, button, textarea, select{
      font:inherit;
      color:var(--text);
      background:rgba(10,12,15,.9);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{
      min-height:110px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    input:focus, button:focus, textarea:focus, select:focus{
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 0 0 3px rgba(110,231,255,.12);
    }
    button{
      cursor:pointer;
      background:linear-gradient(180deg, rgba(110,231,255,.16), rgba(110,231,255,.06));
      user-select:none;
    }
    button.secondary{background:linear-gradient(180deg, rgba(154,167,180,.14), rgba(154,167,180,.06));}
    button.danger{background:linear-gradient(180deg, rgba(255,110,110,.18), rgba(255,110,110,.06)); border-color: rgba(255,110,110,.35);}
    .btnrow{display:flex; gap:8px; flex-wrap:wrap;}
    .small{font-size:12px; color:var(--muted); line-height:1.4;}
    .label{font-size:12px; color:var(--muted); margin-bottom:6px; display:block;}
    .results{margin-top:10px; border:1px solid var(--border); border-radius:12px; overflow:hidden;}
    .result{
      padding:10px 10px;
      border-bottom:1px solid rgba(36,48,64,.7);
      background:rgba(10,12,15,.55);
      cursor:pointer;
    }
    .result:hover{background:rgba(110,231,255,.06);}
    .result.active{background:rgba(110,231,255,.10); outline:1px solid rgba(110,231,255,.25);}
    .result:last-child{border-bottom:none;}
    .rtitle{font-size:13px; font-weight:650;}
    .rmeta{font-size:12px; color:var(--muted); margin-top:2px; display:flex; gap:10px; flex-wrap:wrap;}

    .kwwrap{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;}
    .kw{
      display:inline-flex; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(110,231,255,.22);
      background:rgba(110,231,255,.08);
      font-size:12px;
      user-select:none;
    }

    .viewer{min-height: calc(100vh - 66px); padding:14px;}
    .viewer .card{height:100%;}
    .viewerHeader{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .fileTitle{font-size:14px; font-weight:700;}
    .notice{padding:10px; border-radius:10px; border:1px solid rgba(255,110,110,.35); background:rgba(255,110,110,.06); color:var(--text); font-size:12px; line-height:1.4;}
    .ok{border-color: rgba(110,231,255,.35); background: rgba(110,231,255,.06);}

    .previewBox{border:1px solid rgba(36,48,64,.85); border-radius:12px; background:transparent; overflow:hidden; margin-top:10px;}

    /* Image viewer */
    .viewerControls{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px;}
    .viewerControls .mini{padding:8px 10px; font-size:12px;}
    .previewViewport{
      width:100%;
      height: calc(100vh - 280px);
      min-height:420px;
      overflow:hidden;
      position:relative;
      touch-action:none;
      user-select:none;
      cursor:grab;
    }
    .previewViewport.dragging{cursor:grabbing;}

    /* Stage origin is image center */
    .previewStage{
      position:absolute;
      left:0; top:0;
      transform-origin: 0 0;
      will-change: transform;
    }
    .previewImage{
      position:absolute;
      left:0; top:0;
      transform: translate(-50%, -50%);
      display:block;
      pointer-events:none;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(760px, 100%);
      border:1px solid var(--border);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(18,22,28,.96), rgba(15,19,24,.96));
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      padding:14px;
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .grid1{display:grid; grid-template-columns: 1fr; gap:10px;}
    .row2{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    code{color:var(--accent)}

    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr;}
      .left{border-right:none; border-bottom:1px solid var(--border);}
      .previewViewport{height:60vh;}
      .grid2{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <h1>DWG Library (Viewer)</h1>
      <div class="sub">Loads JSON via Worker, files from R2. Requests go to <code>/requests</code>.</div>
    </div>
    <div class="btnrow">
      <button id="reloadBtn" class="secondary" title="Reload library.json from Worker (no-cache)">Reload</button>
      <button id="requestNewBtn" class="secondary" title="Request a new item be added">Request new item</button>
      <button id="requestEditBtn" class="secondary" style="display:none;" title="Request edits to selected item">Request edit</button>
    </div>
  </div>
</header>

<div class="wrap">
  <aside class="left">
    <div class="pane">
      <div class="card stack">
        <div class="small" id="srcLine">Source: (loading…)</div>

        <div class="stack">
          <input id="searchBox" placeholder="Search keywords, name…" />
          <div class="btnrow">
            <button id="resetBtn" class="secondary">Reset</button>
          </div>
        </div>

        <div class="small" id="statusLine">Loading…</div>
        <div class="results" id="results"></div>

        <div class="small" id="countLine"></div>
      </div>
    </div>
  </aside>

  <main class="right viewer">
    <div class="card">
      <div class="viewerHeader">
        <div>
          <div class="fileTitle" id="title">No item selected</div>
          <div class="small" id="meta"></div>
        </div>
        <div class="btnrow">
          <a id="downloadDwgLink" style="display:none; text-decoration:none;">
            <button>Download DWG</button>
          </a>
        </div>
      </div>

      <div class="previewBox">
        <div id="previewHost" class="previewViewport" style="display:flex;align-items:center;justify-content:center;color:#667;padding:18px;">
          Select an item to preview its PNG.
        </div>
      </div>

      <div class="viewerControls">
        <button id="zoomOutBtn" class="secondary mini">−</button>
        <button id="zoomInBtn" class="secondary mini">+</button>
        <button id="centerBtn" class="secondary mini">Center</button>
        <button id="fitBtn" class="secondary mini">Fit</button>
        <button id="resetViewBtn" class="secondary mini">Reset</button>
        <button id="rotLeftBtn" class="secondary mini">⟲ 90°</button>
        <button id="rotRightBtn" class="secondary mini">⟳ 90°</button>
      </div>

      <div class="stack" style="margin-top:10px;">
        <div>
          <div class="small"><b>Keywords</b></div>
          <div class="kwwrap" id="kwWrap"></div>
        </div>

        <div id="warn" class="notice" style="display:none;"></div>
        <div id="info" class="notice ok" style="display:none;"></div>
      </div>
    </div>
  </main>
</div>

<!-- Request modal -->
<div class="modalBackdrop" id="modalBackdrop">
  <div class="modal">
    <div class="row2">
      <div>
        <div class="fileTitle" style="font-size:14px;font-weight:700;" id="reqModalTitle">Send request</div>
        <div class="small" id="reqModalSub">This creates a request entry in KV. No uploads. No secrets.</div>
      </div>
      <div class="btnrow">
        <button id="closeModalBtn" class="secondary">Cancel</button>
        <button id="sendReqBtn">Send request</button>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <label class="label">Request type</label>
        <select id="reqType">
          <option value="new">New item</option>
          <option value="edit">Edit existing item</option>
        </select>
      </div>
      <div>
        <label class="label">Existing item ID (only for edit)</label>
        <input id="reqItemId" placeholder="e.g. rw-detail-01" />
      </div>
    </div>

    <div class="grid2">
      <div>
        <label class="label">Your name</label>
        <input id="reqByName" placeholder="e.g. Ben" />
      </div>
      <div>
        <label class="label">Your email (optional)</label>
        <input id="reqByEmail" placeholder="e.g. ben@example.com" />
      </div>
    </div>

    <div class="grid1">
      <div>
        <label class="label">Item name</label>
        <input id="reqName" placeholder="e.g. Planter retaining wall" />
      </div>
      <div>
        <label class="label">Keywords (comma or space separated)</label>
        <input id="reqKeywords" placeholder="masonry, retaining, planter" />
      </div>
      <div>
        <label class="label">Notes (include links to DWG/PNG if you have them)</label>
        <textarea id="reqNotes" placeholder="What should change? Where are the files? Anything helpful..."></textarea>
      </div>
      <div class="small" id="reqStatus" style="color:var(--muted);"></div>
      <div class="notice" id="reqWarn" style="display:none;"></div>
      <div class="notice ok" id="reqOk" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
(() => {
  // ================== CONFIG ==================
  // PASTE WORKER BASE HERE (no trailing slash)
  const WORKER_BASE = "https://dwg-library-admin-worker.bendbartley.workers.dev";

  const LIBRARY_URL  = `${WORKER_BASE}/library`;
  const REQUESTS_URL = `${WORKER_BASE}/requests`;

  // ================== UI refs ==================
  const resultsEl = document.getElementById("results");
  const statusLine = document.getElementById("statusLine");
  const countLine = document.getElementById("countLine");
  const searchBox = document.getElementById("searchBox");
  const resetBtn = document.getElementById("resetBtn");
  const reloadBtn = document.getElementById("reloadBtn");
  const srcLine = document.getElementById("srcLine");

  const titleEl = document.getElementById("title");
  const metaEl = document.getElementById("meta");
  const previewHost = document.getElementById("previewHost");
  const kwWrap = document.getElementById("kwWrap");
  const warnEl = document.getElementById("warn");
  const infoEl = document.getElementById("info");
  const downloadDwgLink = document.getElementById("downloadDwgLink");

  const requestNewBtn = document.getElementById("requestNewBtn");
  const requestEditBtn = document.getElementById("requestEditBtn");

  const zoomInBtn = document.getElementById("zoomInBtn");
  const zoomOutBtn = document.getElementById("zoomOutBtn");
  const centerBtn = document.getElementById("centerBtn");
  const fitBtn = document.getElementById("fitBtn");
  const resetViewBtn = document.getElementById("resetViewBtn");
  const rotLeftBtn = document.getElementById("rotLeftBtn");
  const rotRightBtn = document.getElementById("rotRightBtn");

  // Modal refs
  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const sendReqBtn = document.getElementById("sendReqBtn");
  const reqTypeEl = document.getElementById("reqType");
  const reqItemIdEl = document.getElementById("reqItemId");
  const reqByNameEl = document.getElementById("reqByName");
  const reqByEmailEl = document.getElementById("reqByEmail");
  const reqNameEl = document.getElementById("reqName");
  const reqKeywordsEl = document.getElementById("reqKeywords");
  const reqNotesEl = document.getElementById("reqNotes");
  const reqStatusEl = document.getElementById("reqStatus");
  const reqWarnEl = document.getElementById("reqWarn");
  const reqOkEl = document.getElementById("reqOk");
  const reqModalTitle = document.getElementById("reqModalTitle");

  // ================== State ==================
  let items = [];
  let filtered = [];
  let activeId = null;

  // -------- Viewer state (pan/zoom/rotate about image center) --------
  let view = {
    scale: 1,
    minScale: 0.05,
    maxScale: 20,
    tx: 0,  // stage origin x in viewport coords
    ty: 0,  // stage origin y in viewport coords
    rot: 0, // degrees
    imgW: 0,
    imgH: 0
  };

  let viewportEl = null;
  let stageEl = null;
  let currentImgEl = null;
  let drag = { active:false, startX:0, startY:0, startTx:0, startTy:0 };

  // ================== Helpers ==================
  function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function showWarn(msg){ warnEl.style.display="block"; warnEl.textContent=msg; }
  function hideWarn(){ warnEl.style.display="none"; }
  function showInfo(msg){ infoEl.style.display="block"; infoEl.textContent=msg; }
  function hideInfo(){ infoEl.style.display="none"; }

  function showReqWarn(msg){ reqWarnEl.style.display="block"; reqWarnEl.textContent=msg; }
  function hideReqWarn(){ reqWarnEl.style.display="none"; }
  function showReqOk(msg){ reqOkEl.style.display="block"; reqOkEl.textContent=msg; }
  function hideReqOk(){ reqOkEl.style.display="none"; }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function tokenizeKeywords(s){
    return (s ?? "")
      .toString()
      .split(/[,]+|\s+/)
      .map(norm)
      .filter(Boolean);
  }

  function clearPreview(text){
    previewHost.innerHTML = "";
    previewHost.style.display="flex";
    previewHost.style.alignItems="center";
    previewHost.style.justifyContent="center";
    previewHost.style.color="#667";
    previewHost.style.padding="18px";
    previewHost.textContent = text || "";
    viewportEl = null; stageEl = null; currentImgEl = null;
  }

  function setPreviewElement(el){
    previewHost.innerHTML="";
    previewHost.style.display="block";
    previewHost.style.color="inherit";
    previewHost.style.padding="0";
    previewHost.appendChild(el);
  }

  function rotatedBounds(iw, ih, rotDeg){
    const rad = rotDeg * Math.PI / 180;
    const cos = Math.abs(Math.cos(rad));
    const sin = Math.abs(Math.sin(rad));
    return { w: iw*cos + ih*sin, h: iw*sin + ih*cos };
  }

  function applyTransform(){
    if (!stageEl) return;
    stageEl.style.transform = `translate(${view.tx}px, ${view.ty}px) rotate(${view.rot}deg) scale(${view.scale})`;
  }

  function centerView(){
    if (!viewportEl) return;
    const vw = viewportEl.clientWidth;
    const vh = viewportEl.clientHeight;
    view.tx = vw / 2;
    view.ty = vh / 2;
    applyTransform();
  }

  function fitToViewport(){
    if (!viewportEl || !currentImgEl) return;
    const vw = viewportEl.clientWidth;
    const vh = viewportEl.clientHeight;

    const iw = view.imgW || currentImgEl.naturalWidth || 1;
    const ih = view.imgH || currentImgEl.naturalHeight || 1;

    const rb = rotatedBounds(iw, ih, view.rot);
    const s = Math.min(vw / rb.w, vh / rb.h) * 0.98;
    view.scale = clamp(s, view.minScale, view.maxScale);

    centerView();
  }

  function zoomAt(clientX, clientY, factor){
    if (!viewportEl) return;
    const rect = viewportEl.getBoundingClientRect();
    const px = clientX - rect.left;
    const py = clientY - rect.top;

    const oldScale = view.scale;
    const newScale = clamp(oldScale * factor, view.minScale, view.maxScale);
    if (newScale === oldScale) return;

    view.tx = px - (px - view.tx) * (newScale / oldScale);
    view.ty = py - (py - view.ty) * (newScale / oldScale);
    view.scale = newScale;

    applyTransform();
  }

  function setRotation(deg){
    view.rot = ((deg % 360) + 360) % 360;
    if (view.rot > 180) view.rot -= 360;
    centerView();
  }

  function resetView(){
    view.rot = 0;
    fitToViewport();
  }

  function wireViewerInteractions(viewport){
    viewport.onpointerdown = (e) => {
      if (e.pointerType === "mouse" && e.button !== 0) return;
      viewport.setPointerCapture(e.pointerId);
      drag.active = true;
      drag.startX = e.clientX;
      drag.startY = e.clientY;
      drag.startTx = view.tx;
      drag.startTy = view.ty;
      viewport.classList.add("dragging");
    };

    viewport.onpointermove = (e) => {
      if (!drag.active) return;
      const dx = e.clientX - drag.startX;
      const dy = e.clientY - drag.startY;
      view.tx = drag.startTx + dx;
      view.ty = drag.startTy + dy;
      applyTransform();
    };

    viewport.onpointerup = (e) => {
      drag.active = false;
      viewport.classList.remove("dragging");
      try{ viewport.releasePointerCapture(e.pointerId); } catch {}
    };

    viewport.onpointercancel = () => {
      drag.active = false;
      viewport.classList.remove("dragging");
    };

    viewport.addEventListener("wheel", (e) => {
      e.preventDefault();
      const factor = e.deltaY > 0 ? 0.90 : 1.10;
      zoomAt(e.clientX, e.clientY, factor);
    }, { passive:false });

    const ro = new ResizeObserver(() => centerView());
    ro.observe(viewport);
  }

  // ================== Library load ==================
  async function loadLibrary(){
    hideWarn(); hideInfo();
    statusLine.textContent = "Loading library…";
    srcLine.textContent = `Source: ${LIBRARY_URL}`;

    const url = LIBRARY_URL + (LIBRARY_URL.includes("?") ? "&" : "?") + `cb=${Date.now()}`;

    const res = await fetch(url, {
      cache: "no-store",
      headers: { "Accept": "application/json" }
    });

    if (!res.ok){
      const txt = await res.text();
      throw new Error(`library load failed (${res.status}): ${txt.slice(0, 300)}`);
    }

    const json = await res.json();
    const list = Array.isArray(json) ? json : (json?.items || []);
    if (!Array.isArray(list)) throw new Error("library.json is not an array (or {items:[]})");

    items = list.map((it, idx) => ({
      id: (it.id ?? `item_${idx}`).toString(),
      name: (it.name ?? "Untitled").toString(),
      keywords: Array.from(new Set((it.keywords || []).map(norm).filter(Boolean))).sort(),
      pngUrl: (it.pngUrl || it.png || it.preview || "").toString(),
      dwgUrl: (it.dwgUrl || it.dwg || it.download || "").toString(),
      updatedUtc: (it.updatedUtc || it.updated || "").toString()
    }));

    statusLine.textContent = `Loaded ${items.length} items`;
    applyFilter();

    if (items.length === 0){
      activeId = null;
      requestEditBtn.style.display = "none";
      titleEl.textContent = "No item selected";
      metaEl.textContent = "";
      downloadDwgLink.style.display = "none";
      kwWrap.innerHTML = "";
      clearPreview("No items in library.json.");
      return;
    }

    if (!activeId || !items.some(x => x.id === activeId)){
      await selectItem(items[0].id);
    } else {
      await selectItem(activeId);
    }
  }

  // ================== Search/list ==================
  function applyFilter(){
    const q = norm(searchBox.value);
    const tokens = q.split(/\s+/).filter(Boolean);

    if (tokens.length === 0){
      filtered = [...items].sort((a,b) => (a.name||"").localeCompare(b.name||""));
    } else {
      filtered = items
        .map(it => {
          const hay = (it.name + " " + (it.keywords||[]).join(" ")).toLowerCase();
          let score = 0;
          for (const t of tokens){
            if ((it.keywords||[]).some(k => k.includes(t))) score += 3;
            if (hay.includes(t)) score += 1;
          }
          return { it, score };
        })
        .filter(x => x.score > 0)
        .sort((a,b) => b.score - a.score || (a.it.name||"").localeCompare(b.it.name||""))
        .map(x => x.it);
    }

    renderResults();
    countLine.textContent = `${filtered.length} / ${items.length} items shown`;
  }

  function renderResults(){
    resultsEl.innerHTML = "";
    if (filtered.length === 0){
      const d = document.createElement("div");
      d.className = "result";
      d.style.cursor = "default";
      d.innerHTML = `<div class="rtitle">No matches</div><div class="rmeta">Try fewer keywords.</div>`;
      resultsEl.appendChild(d);
      return;
    }

    for (const it of filtered){
      const row = document.createElement("div");
      row.className = "result" + (it.id === activeId ? " active" : "");
      row.addEventListener("click", () => selectItem(it.id));
      const kwPrev = (it.keywords || []).slice(0, 6).join(", ");
      row.innerHTML = `
        <div class="rtitle">${escapeHtml(it.name || "Untitled")}</div>
        <div class="rmeta">
          <span>${(it.keywords||[]).length} keywords</span>
          <span>•</span>
          <span>${escapeHtml(kwPrev || "none")}${(it.keywords||[]).length>6 ? "…" : ""}</span>
        </div>
      `;
      resultsEl.appendChild(row);
    }
  }

  function renderKeywords(it){
    kwWrap.innerHTML = "";
    const kws = it.keywords || [];
    if (kws.length === 0){
      const s = document.createElement("div");
      s.className = "small";
      s.textContent = "No keywords.";
      kwWrap.appendChild(s);
      return;
    }
    for (const k of kws){
      const chip = document.createElement("div");
      chip.className = "kw";
      chip.textContent = k;
      kwWrap.appendChild(chip);
    }
  }

  // ================== Selection ==================
  async function selectItem(itemId){
    hideWarn(); hideInfo();
    activeId = itemId;
    renderResults();

    const it = items.find(x => x.id === itemId);
    if (!it){
      requestEditBtn.style.display = "none";
      showWarn("Item missing from current list.");
      return;
    }

    requestEditBtn.style.display = "inline-block";

    titleEl.textContent = it.name || "Untitled";
    metaEl.textContent = `ID: ${it.id} | PNG: ${it.pngUrl ? "yes" : "missing"} | DWG: ${it.dwgUrl ? "yes" : "missing"}${it.updatedUtc ? " | Updated: " + it.updatedUtc : ""}`;

    renderKeywords(it);

    if (it.dwgUrl){
      downloadDwgLink.style.display = "inline-block";
      downloadDwgLink.href = it.dwgUrl;
      downloadDwgLink.target = "_blank";
      downloadDwgLink.rel = "noopener";
    } else {
      downloadDwgLink.style.display = "none";
    }

    if (it.pngUrl){
      previewPngUrl(it.pngUrl, it.name);
    } else {
      clearPreview("No PNG URL for this item.");
    }
  }

  function previewPngUrl(pngUrl, name){
    try{
      const viewport = document.createElement("div");
      viewport.className = "previewViewport";
      viewportEl = viewport;

      const stage = document.createElement("div");
      stage.className = "previewStage";
      stageEl = stage;

      const img = document.createElement("img");
      img.className = "previewImage";
      img.alt = name || "PNG preview";
      currentImgEl = img;

      img.onload = () => {
        view.imgW = img.naturalWidth;
        view.imgH = img.naturalHeight;
        showInfo(`Previewing: ${name || "PNG"}`);
        fitToViewport();
      };

      img.onerror = () => {
        clearPreview("Could not render PNG preview.");
        showWarn("PNG failed to load. Check the R2 URL and CORS headers.");
      };

      // Cache-bust preview too (R2 is usually fine, but browsers are not)
      const src = pngUrl + (pngUrl.includes("?") ? "&" : "?") + `cb=${Date.now()}`;
      img.src = src;

      stage.appendChild(img);
      viewport.appendChild(stage);

      setPreviewElement(viewport);
      wireViewerInteractions(viewport);
    } catch (err){
      clearPreview("Could not render PNG preview.");
      showWarn("PNG preview failed: " + (err?.message || err));
    }
  }

  // ================== Requests UI ==================
  function openModal(kind){
    hideReqWarn(); hideReqOk();
    reqStatusEl.textContent = "";

    const selected = items.find(x => x.id === activeId) || null;

    if (kind === "new"){
      reqModalTitle.textContent = "Request: New item";
      reqTypeEl.value = "new";
      reqItemIdEl.value = "";
      reqNameEl.value = "";
      reqKeywordsEl.value = "";
      reqNotesEl.value = "";
      reqItemIdEl.disabled = true;
    } else {
      reqModalTitle.textContent = "Request: Edit item";
      reqTypeEl.value = "edit";
      reqItemIdEl.value = selected?.id || "";
      reqNameEl.value = selected?.name || "";
      reqKeywordsEl.value = (selected?.keywords || []).join(", ");
      reqNotesEl.value = "";
      reqItemIdEl.disabled = false;
    }

    modalBackdrop.style.display = "flex";
    setReqTypeUI();
  }

  function closeModal(){
    modalBackdrop.style.display = "none";
  }

  function setReqTypeUI(){
    const t = reqTypeEl.value;
    if (t === "edit"){
      reqItemIdEl.disabled = false;
    } else {
      reqItemIdEl.disabled = true;
      reqItemIdEl.value = "";
    }
  }

  async function sendRequest(){
    hideReqWarn(); hideReqOk();
    reqStatusEl.textContent = "Sending…";

    const type = (reqTypeEl.value || "").toLowerCase();
    if (type !== "new" && type !== "edit"){
      showReqWarn("Request type must be new or edit.");
      reqStatusEl.textContent = "";
      return;
    }

    const byName = (reqByNameEl.value || "").trim();
    const byEmail = (reqByEmailEl.value || "").trim();

    if (!byName){
      showReqWarn("Please enter your name.");
      reqStatusEl.textContent = "";
      return;
    }

    const itemId = (reqItemIdEl.value || "").trim();
    if (type === "edit" && !itemId){
      showReqWarn("Edit requests must include an existing item ID.");
      reqStatusEl.textContent = "";
      return;
    }

    const itemName = (reqNameEl.value || "").trim();
    const keywords = tokenizeKeywords(reqKeywordsEl.value);
    const notes = (reqNotesEl.value || "").trim();

    const payload = {
      type,
      requestedBy: { name: byName, email: byEmail },
      item: {
        id: itemId,
        name: itemName,
        keywords
      },
      notes
    };

    try{
      const res = await fetch(REQUESTS_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload),
        cache: "no-store"
      });

      const text = await res.text();
      let data = null;
      try{ data = JSON.parse(text); } catch {}

      if (!res.ok){
        showReqWarn(`Request failed (${res.status}): ${text.slice(0, 300)}`);
        reqStatusEl.textContent = "";
        return;
      }

      const id = data?.id || "(no id returned)";
      showReqOk(`Request submitted. ID: ${id}`);
      reqStatusEl.textContent = "";

      // keep modal open so user can copy id, then close if they want
    } catch (e){
      showReqWarn(String(e?.message || e));
      reqStatusEl.textContent = "";
    }
  }

  // ================== Events ==================
  reloadBtn.addEventListener("click", async () => {
    try{ await loadLibrary(); showInfo("Reloaded library."); } catch(e){ showWarn(e.message || String(e)); }
  });

  searchBox.addEventListener("input", applyFilter);
  resetBtn.addEventListener("click", () => { searchBox.value=""; applyFilter(); });

  zoomInBtn.addEventListener("click", () => {
    if (!viewportEl) return;
    const rect = viewportEl.getBoundingClientRect();
    zoomAt(rect.left + rect.width/2, rect.top + rect.height/2, 1.25);
  });

  zoomOutBtn.addEventListener("click", () => {
    if (!viewportEl) return;
    const rect = viewportEl.getBoundingClientRect();
    zoomAt(rect.left + rect.width/2, rect.top + rect.height/2, 0.8);
  });

  centerBtn.addEventListener("click", () => centerView());
  fitBtn.addEventListener("click", () => fitToViewport());
  resetViewBtn.addEventListener("click", () => resetView());
  rotLeftBtn.addEventListener("click", () => setRotation(view.rot - 90));
  rotRightBtn.addEventListener("click", () => setRotation(view.rot + 90));

  // Requests modal wiring
  requestNewBtn.addEventListener("click", () => openModal("new"));
  requestEditBtn.addEventListener("click", () => openModal("edit"));
  closeModalBtn.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });
  reqTypeEl.addEventListener("change", setReqTypeUI);
  sendReqBtn.addEventListener("click", sendRequest);

  // ================== Boot ==================
  (async () => {
    try{
      clearPreview("Loading…");
      await loadLibrary();
      if (items.length) clearPreview("Select an item to preview its PNG.");
    } catch (err){
      statusLine.textContent = "Load failed";
      clearPreview("Could not load library.");
      showWarn(err?.message || String(err));
    }
  })();
})();
</script>
</body>
</html>
