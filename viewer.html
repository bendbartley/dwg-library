<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DWG Library Viewer (GitHub JSON + R2)</title>
  <style>
    :root{
      --bg:#0b0d10; --panel:#12161c; --panel2:#0f1318;
      --text:#e7edf3; --muted:#9aa7b4; --accent:#6ee7ff; --bad:#ff6e6e;
      --border:#243040;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:linear-gradient(180deg,#080a0d,#0b0d10 30%,#07090b);
      color:var(--text);
    }
    header{
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      background:rgba(18,22,28,.9);
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(6px);
    }
    header .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    h1{font-size:16px;margin:0;font-weight:650;letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12px}
    .wrap{display:grid; grid-template-columns: 380px 1fr; min-height: calc(100vh - 66px);}
    .left{border-right:1px solid var(--border); background:rgba(18,22,28,.65);}
    .right{background:rgba(10,12,15,.4);}
    .pane{padding:14px;}
    .card{
      background:linear-gradient(180deg, rgba(18,22,28,.9), rgba(15,19,24,.9));
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .stack{display:flex; flex-direction:column; gap:10px;}
    input, button, textarea{
      font:inherit;
      color:var(--text);
      background:rgba(10,12,15,.9);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    input:focus, button:focus, textarea:focus{
      border-color: rgba(110,231,255,.55);
      box-shadow: 0 0 0 3px rgba(110,231,255,.12);
    }
    button{
      cursor:pointer;
      background:linear-gradient(180deg, rgba(110,231,255,.16), rgba(110,231,255,.06));
      user-select:none;
    }
    button.secondary{
      background:linear-gradient(180deg, rgba(154,167,180,.14), rgba(154,167,180,.06));
    }
    button.danger{
      background:linear-gradient(180deg, rgba(255,110,110,.18), rgba(255,110,110,.06));
      border-color: rgba(255,110,110,.35);
    }
    .btnrow{display:flex; gap:8px; flex-wrap:wrap;}
    .small{font-size:12px; color:var(--muted); line-height:1.4;}
    .results{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
    }
    .result{
      padding:10px 10px;
      border-bottom:1px solid rgba(36,48,64,.7);
      background:rgba(10,12,15,.55);
      cursor:pointer;
    }
    .result:hover{background:rgba(110,231,255,.06);}
    .result.active{background:rgba(110,231,255,.10); outline:1px solid rgba(110,231,255,.25);}
    .result:last-child{border-bottom:none;}
    .rtitle{font-size:13px; font-weight:650;}
    .rmeta{font-size:12px; color:var(--muted); margin-top:2px; display:flex; gap:10px; flex-wrap:wrap;}
    .kwwrap{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;}
    .kw{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(110,231,255,.22);
      background:rgba(110,231,255,.08);
      font-size:12px;
      user-select:none;
      cursor:default;
    }

    .viewer{min-height: calc(100vh - 66px); padding:14px;}
    .viewer .card{height:100%;}
    .viewerHeader{display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;}
    .fileTitle{font-size:14px; font-weight:700;}

    .notice{
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.06);
      color:var(--text);
      font-size:12px;
      line-height:1.4;
    }
    .ok{border-color: rgba(110,231,255,.35); background: rgba(110,231,255,.06);}

    .previewBox{
      border:1px solid rgba(36,48,64,.85);
      border-radius:12px;
      background:#ffffff;
      overflow:hidden;
      margin-top:10px;
    }

    /* Image viewer */
    .viewerControls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .viewerControls .mini{
      padding:8px 10px;
      font-size:12px;
    }
    .previewViewport{
      width:100%;
      height: calc(100vh - 260px);
      min-height:420px;
      overflow:hidden;
      position:relative;
      touch-action:none;
      user-select:none;
      cursor:grab;
    }
    .previewViewport.dragging{ cursor:grabbing; }
    .previewStage{
      position:absolute;
      left:0;
      top:0;
      will-change: transform;
    }
    .previewImage{
      display:block;
      pointer-events:none;
      width:100%;
      height:100%;
    }

    .footerBar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:space-between; margin-top:10px;
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:999;
    }
    .modal{
      width:min(860px, 100%);
      border:1px solid var(--border);
      border-radius:14px;
      background:linear-gradient(180deg, rgba(18,22,28,.96), rgba(15,19,24,.96));
      box-shadow: 0 20px 80px rgba(0,0,0,.55);
      padding:14px;
    }
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .grid1{display:grid; grid-template-columns: 1fr; gap:10px;}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(154,167,180,.25);
      background:rgba(154,167,180,.08);
      font-size:12px; color:var(--muted);
    }

    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr;}
      .left{border-right:none; border-bottom:1px solid var(--border);}
      .previewViewport{height:60vh;}
      .grid2{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div>
      <h1>DWG Library (GitHub JSON + R2)</h1>
      <div class="sub">
        Viewer is static. Data comes from <span class="pill" id="libUrlPill">library.json</span>
      </div>
    </div>
    <div class="btnrow">
      <button id="reloadBtn" class="secondary" title="Forces a fresh fetch of library.json">Reload</button>
      <button id="requestAddBtn">Request Add</button>
      <button id="requestEditBtn" class="secondary" disabled title="Select an item first">Request Edit</button>
    </div>
  </div>
</header>

<div class="wrap">
  <aside class="left">
    <div class="pane">
      <div class="card stack">
        <div class="small">
          Shared library: everyone sees the same data because it’s just JSON + URLs. No browser-local databases. What a concept.
        </div>

        <div class="stack">
          <input id="searchBox" placeholder="Search name, keywords…" />
          <div class="btnrow">
            <button id="resetBtn" class="secondary">Reset</button>
          </div>
        </div>

        <div class="small" id="statusLine">Loading…</div>
        <div class="results" id="results"></div>
        <div class="small" id="countLine"></div>

        <div id="warnLeft" class="notice" style="display:none;"></div>
      </div>
    </div>
  </aside>

  <main class="right viewer">
    <div class="card">
      <div class="viewerHeader">
        <div>
          <div class="fileTitle" id="title">No item selected</div>
          <div class="small" id="meta"></div>
        </div>
        <div class="btnrow">
          <button id="downloadDwgBtn" style="display:none;">Download DWG</button>
          <button id="openPngBtn" class="secondary" style="display:none;">Open PNG</button>
        </div>
      </div>

      <div class="previewBox">
        <div id="previewHost" class="previewViewport" style="display:flex;align-items:center;justify-content:center;color:#667;padding:18px;">
          Select an item to preview its PNG.
        </div>
      </div>

      <div class="viewerControls">
        <button id="zoomOutBtn" class="secondary mini">−</button>
        <button id="zoomInBtn" class="secondary mini">+</button>
        <button id="fitBtn" class="secondary mini">Fit</button>
        <button id="centerBtn" class="secondary mini">Center</button>
        <button id="resetViewBtn" class="secondary mini">Reset</button>
        <button id="rotLeftBtn" class="secondary mini">⟲ 90°</button>
        <button id="rotRightBtn" class="secondary mini">⟳ 90°</button>
        <span class="pill" id="viewPill">Zoom 100% • Rot 0°</span>
      </div>

      <div class="stack" style="margin-top:10px;">
        <div>
          <div class="small"><b>Keywords</b></div>
          <div class="kwwrap" id="kwWrap"></div>
        </div>

        <div id="warn" class="notice" style="display:none;"></div>
        <div id="info" class="notice ok" style="display:none;"></div>
      </div>

      <div class="footerBar">
        <div class="small">PNG preview: pan (drag), zoom (wheel/buttons), rotate (90° buttons).</div>
        <div class="small">Edits go via email request. Yes, it’s primitive. It’s also reliable.</div>
      </div>
    </div>
  </main>
</div>

<!-- Request Modal -->
<div class="modalBackdrop" id="modalBackdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap;">
      <div>
        <div class="fileTitle" id="modalTitle">Request</div>
        <div class="small" id="modalSub">Creates an email draft (mailto).</div>
      </div>
      <div class="btnrow">
        <button id="closeModalBtn" class="secondary">Cancel</button>
        <button id="emailBtn">Open Email Draft</button>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <label>Your name (optional)</label>
        <input id="reqName" placeholder="e.g. Ben" />
      </div>
      <div>
        <label>Your email (optional)</label>
        <input id="reqEmail" placeholder="e.g. ben@…" />
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>Item name</label>
        <input id="reqItemName" placeholder="e.g. Planter retaining wall" />
      </div>
      <div>
        <label>Keywords (comma separated)</label>
        <input id="reqKeywords" placeholder="masonry, retaining, planter" />
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>DWG URL (R2)</label>
        <input id="reqDwgUrl" placeholder="https://pub-xxxx.r2.dev/whatever.dwg" />
      </div>
      <div>
        <label>PNG URL (R2)</label>
        <input id="reqPngUrl" placeholder="https://pub-xxxx.r2.dev/whatever.png" />
      </div>
    </div>

    <div class="grid1">
      <div>
        <label>Request details</label>
        <textarea id="reqNotes" placeholder="What should change? If you’re requesting an add, describe the drawing + where it fits."></textarea>
      </div>
      <div class="small" id="modalMsg" style="color:var(--muted);">
        Note: mailto cannot attach files automatically. If you need to send files, attach them manually in your email client.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // =========================================================
  // CONFIG (edit these for your repo)
  // =========================================================

  // 1) Where the shared database lives
  // Use a GitHub Pages URL (best) or raw.githubusercontent.com. Either is fine.
  const LIBRARY_JSON_URL = "https://bendbartley.github.io/dwg-library/library.json";

  // 2) Where users send change requests
  const ADMIN_EMAIL = "YOUR_ADMIN_EMAIL_HERE@domain.com";

  // 3) If true, appends ?v=... to PNG/DWG URLs when opening/downloading
  // Only enable if you NEVER use signed URLs and your URLs tolerate query strings.
  const BUST_R2_URLS = false;

  // =========================================================
  // UI refs
  // =========================================================
  const resultsEl = document.getElementById("results");
  const statusLine = document.getElementById("statusLine");
  const countLine = document.getElementById("countLine");
  const searchBox = document.getElementById("searchBox");
  const resetBtn = document.getElementById("resetBtn");
  const reloadBtn = document.getElementById("reloadBtn");

  const titleEl = document.getElementById("title");
  const metaEl = document.getElementById("meta");
  const previewHost = document.getElementById("previewHost");
  const kwWrap = document.getElementById("kwWrap");
  const warnEl = document.getElementById("warn");
  const infoEl = document.getElementById("info");
  const warnLeft = document.getElementById("warnLeft");
  const downloadDwgBtn = document.getElementById("downloadDwgBtn");
  const openPngBtn = document.getElementById("openPngBtn");
  const requestAddBtn = document.getElementById("requestAddBtn");
  const requestEditBtn = document.getElementById("requestEditBtn");
  const viewPill = document.getElementById("viewPill");
  const libUrlPill = document.getElementById("libUrlPill");

  const zoomInBtn = document.getElementById("zoomInBtn");
  const zoomOutBtn = document.getElementById("zoomOutBtn");
  const fitBtn = document.getElementById("fitBtn");
  const centerBtn = document.getElementById("centerBtn");
  const resetViewBtn = document.getElementById("resetViewBtn");
  const rotLeftBtn = document.getElementById("rotLeftBtn");
  const rotRightBtn = document.getElementById("rotRightBtn");

  // Modal
  const modalBackdrop = document.getElementById("modalBackdrop");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const emailBtn = document.getElementById("emailBtn");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalMsg = document.getElementById("modalMsg");

  const reqName = document.getElementById("reqName");
  const reqEmail = document.getElementById("reqEmail");
  const reqItemName = document.getElementById("reqItemName");
  const reqKeywords = document.getElementById("reqKeywords");
  const reqDwgUrl = document.getElementById("reqDwgUrl");
  const reqPngUrl = document.getElementById("reqPngUrl");
  const reqNotes = document.getElementById("reqNotes");

  // =========================================================
  // State
  // =========================================================
  let library = [];      // full
  let filtered = [];     // filtered
  let activeId = null;
  let activeItem = null;

  // =========================================================
  // Helpers
  // =========================================================
  libUrlPill.textContent = LIBRARY_JSON_URL;

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }
  function asArray(x){
    if (Array.isArray(x)) return x;
    if (typeof x === "string") return x.split(/[,]+|\s+/).map(norm).filter(Boolean);
    return [];
  }
  function showWarn(el, msg){ el.style.display="block"; el.textContent=msg; }
  function hideWarn(el){ el.style.display="none"; el.textContent=""; }
  function showInfo(msg){ infoEl.style.display="block"; infoEl.textContent=msg; }
  function hideInfo(){ infoEl.style.display="none"; infoEl.textContent=""; }

  function bustUrl(url){
    if (!url) return url;
    if (!BUST_R2_URLS) return url;
    const sep = url.includes("?") ? "&" : "?";
    return url + sep + "v=" + Date.now();
  }

  // =========================================================
  // Load library.json (always fresh)
  // =========================================================
  async function loadLibrary(){
    hideWarn(warnLeft);
    statusLine.textContent = "Loading library.json…";

    const url = LIBRARY_JSON_URL + (LIBRARY_JSON_URL.includes("?") ? "&" : "?") + "v=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });

    if (!res.ok){
      throw new Error(`library.json fetch failed (${res.status})`);
    }

    const data = await res.json();
    if (!Array.isArray(data)){
      throw new Error("library.json must be a JSON array of items");
    }

    // Normalize items
    const cleaned = data.map((it, idx) => {
      const id = it.id ?? it.key ?? it.slug ?? ("item_" + idx);
      const name = it.name ?? it.title ?? "Untitled";
      const keywords = Array.from(new Set(asArray(it.keywords ?? it.tags ?? it.kw))).sort();

      // Support different naming
      const dwgUrl = it.dwgUrl ?? it.dwg_url ?? it.dwg ?? it.dwgLink ?? it.dwg_link ?? "";
      const pngUrl = it.pngUrl ?? it.png_url ?? it.png ?? it.preview ?? it.previewUrl ?? "";

      const updatedUtc = it.updatedUtc ?? it.updated_utc ?? it.updated ?? it.modified ?? "";
      const createdUtc = it.createdUtc ?? it.created_utc ?? it.created ?? "";

      return {
        ...it,
        id: id.toString(),
        name: name.toString(),
        keywords,
        dwgUrl: dwgUrl ? dwgUrl.toString() : "",
        pngUrl: pngUrl ? pngUrl.toString() : "",
        updatedUtc: updatedUtc ? updatedUtc.toString() : "",
        createdUtc: createdUtc ? createdUtc.toString() : ""
      };
    });

    library = cleaned;
    statusLine.textContent = `Loaded ${library.length} items`;
    applyFilter(true);
  }

  // =========================================================
  // Search + list
  // =========================================================
  function applyFilter(keepSelection){
    const q = norm(searchBox.value);
    const tokens = q.split(/\s+/).filter(Boolean);

    if (tokens.length === 0){
      filtered = [...library].sort((a,b) => (a.name||"").localeCompare(b.name||""));
    } else {
      filtered = library
        .map(it => {
          const hay = (it.name + " " + (it.keywords||[]).join(" ")).toLowerCase();
          let score = 0;
          for (const t of tokens){
            if ((it.keywords||[]).some(k => k.includes(t))) score += 3;
            if (hay.includes(t)) score += 1;
          }
          return { it, score };
        })
        .filter(x => x.score > 0)
        .sort((a,b) => b.score - a.score || (a.it.name||"").localeCompare(b.it.name||""))
        .map(x => x.it);
    }

    renderResults();
    countLine.textContent = `${filtered.length} / ${library.length} items shown`;

    if (!keepSelection){
      activeId = null;
      activeItem = null;
      renderActive(null);
    } else {
      if (activeId && !library.some(x => x.id === activeId)){
        activeId = null;
        activeItem = null;
        renderActive(null);
      }
      if (!activeId && filtered.length){
        selectItem(filtered[0].id);
      }
    }
  }

  function renderResults(){
    resultsEl.innerHTML = "";

    if (filtered.length === 0){
      const d = document.createElement("div");
      d.className = "result";
      d.style.cursor = "default";
      d.innerHTML = `<div class="rtitle">No matches</div><div class="rmeta">Try fewer keywords.</div>`;
      resultsEl.appendChild(d);
      return;
    }

    for (const it of filtered){
      const row = document.createElement("div");
      row.className = "result" + (it.id === activeId ? " active" : "");
      row.addEventListener("click", () => selectItem(it.id));

      const kwPrev = (it.keywords || []).slice(0, 6).join(", ");
      const flags = [
        it.dwgUrl ? "DWG" : null,
        it.pngUrl ? "PNG" : null
      ].filter(Boolean).join(" • ");

      row.innerHTML = `
        <div class="rtitle">${escapeHtml(it.name || "Untitled")}</div>
        <div class="rmeta">
          <span>${(it.keywords||[]).length} keywords</span>
          <span>•</span>
          <span>${escapeHtml(kwPrev || "none")}${(it.keywords||[]).length>6 ? "…" : ""}</span>
          ${flags ? `<span>•</span><span>${flags}</span>` : ""}
        </div>
      `;
      resultsEl.appendChild(row);
    }
  }

  function selectItem(itemId){
    hideWarn(warnEl); hideInfo(); hideWarn(warnLeft);

    activeId = itemId;
    activeItem = library.find(x => x.id === itemId) || null;

    renderResults();
    renderActive(activeItem);
  }

  function renderKeywords(it){
    kwWrap.innerHTML = "";
    const kws = it?.keywords || [];
    if (!it){
      kwWrap.innerHTML = `<div class="small">No item selected.</div>`;
      return;
    }
    if (kws.length === 0){
      kwWrap.innerHTML = `<div class="small">No keywords.</div>`;
      return;
    }
    for (const k of kws){
      const chip = document.createElement("div");
      chip.className = "kw";
      chip.textContent = k;
      kwWrap.appendChild(chip);
    }
  }

  // =========================================================
  // Viewer (pan/zoom/rotate about image center)
  // =========================================================
  let viewportEl = null;
  let stageEl = null;
  let imgEl = null;

  let view = {
    scale: 1,
    minScale: 0.05,
    maxScale: 30,
    tx: 0,
    ty: 0,
    rotDeg: 0,
    iw: 1,
    ih: 1
  };

  let drag = { active:false, startX:0, startY:0, startTx:0, startTy:0 };

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function rad(){ return view.rotDeg * Math.PI / 180; }

  function rotatedBounds(iw, ih, rotDeg){
    const r = rotDeg * Math.PI / 180;
    const c = Math.abs(Math.cos(r));
    const s = Math.abs(Math.sin(r));
    return { w: iw*c + ih*s, h: iw*s + ih*c };
  }

  function applyTransform(){
    if (!stageEl) return;

    stageEl.style.width = view.iw + "px";
    stageEl.style.height = view.ih + "px";

    // Rotate/scale around the image center (the whole point of this exercise)
    stageEl.style.transformOrigin = (view.iw/2) + "px " + (view.ih/2) + "px";
    stageEl.style.transform = `translate(${view.tx}px, ${view.ty}px) rotate(${view.rotDeg}deg) scale(${view.scale})`;

    if (viewPill){
      const z = Math.round(view.scale * 100);
      const r = Math.round(view.rotDeg);
      viewPill.textContent = `Zoom ${z}% • Rot ${r}°`;
    }
  }

  function centerView(){
    if (!viewportEl) return;
    const vw = viewportEl.clientWidth;
    const vh = viewportEl.clientHeight;

    // Because rotation/scale are about the image center, centering is simple:
    view.tx = (vw / 2) - (view.iw / 2);
    view.ty = (vh / 2) - (view.ih / 2);
    applyTransform();
  }

  function fitView(){
    if (!viewportEl) return;
    const vw = viewportEl.clientWidth;
    const vh = viewportEl.clientHeight;

    const rb = rotatedBounds(view.iw, view.ih, view.rotDeg);
    const s = Math.min(vw / rb.w, vh / rb.h) * 0.98;

    view.scale = clamp(s, view.minScale, view.maxScale);
    centerView();
  }

  function resetView(){
    view.rotDeg = 0;
    fitView();
  }

  function setRotation(deg){
    // normalize to (-180, 180]
    let d = ((deg % 360) + 360) % 360;
    if (d > 180) d -= 360;
    view.rotDeg = d;
    // keep centered after rotation (human expectation)
    centerView();
  }

  function screenToLocal(px, py){
    // px/py are viewport-relative
    const ox = view.iw / 2;
    const oy = view.ih / 2;

    // undo translation
    let x = px - view.tx;
    let y = py - view.ty;

    // move to origin (center)
    x -= ox;
    y -= oy;

    // undo rotation
    const r = rad();
    const cr = Math.cos(-r);
    const sr = Math.sin(-r);
    const xr = x * cr - y * sr;
    const yr = x * sr + y * cr;

    // undo scale
    const xs = xr / view.scale;
    const ys = yr / view.scale;

    // back to local coords
    return { x: xs + ox, y: ys + oy };
  }

  function localToScreen(lx, ly){
    const ox = view.iw / 2;
    const oy = view.ih / 2;

    // to origin
    let x = lx - ox;
    let y = ly - oy;

    // scale
    x *= view.scale;
    y *= view.scale;

    // rotate
    const r = rad();
    const cr = Math.cos(r);
    const sr = Math.sin(r);
    const xr = x * cr - y * sr;
    const yr = x * sr + y * cr;

    // back + translate
    return { x: xr + ox + view.tx, y: yr + oy + view.ty };
  }

  function zoomAt(clientX, clientY, factor){
    if (!viewportEl) return;

    const rect = viewportEl.getBoundingClientRect();
    const px = clientX - rect.left;
    const py = clientY - rect.top;

    const before = screenToLocal(px, py);

    const oldScale = view.scale;
    const newScale = clamp(oldScale * factor, view.minScale, view.maxScale);
    if (newScale === oldScale) return;

    view.scale = newScale;

    // Adjust translation so the same local point stays under the cursor
    const afterScreen = localToScreen(before.x, before.y);
    view.tx += (px - afterScreen.x);
    view.ty += (py - afterScreen.y);

    applyTransform();
  }

  function buildViewer(pngUrl, pngName){
    const viewport = document.createElement("div");
    viewport.className = "previewViewport";
    viewportEl = viewport;

    const stage = document.createElement("div");
    stage.className = "previewStage";
    stageEl = stage;

    const img = document.createElement("img");
    img.className = "previewImage";
    img.alt = pngName || "PNG preview";
    imgEl = img;

    img.onload = () => {
      view.iw = img.naturalWidth || 1;
      view.ih = img.naturalHeight || 1;

      // set stage size to image size (so transform-origin can be center in px)
      stage.style.width = view.iw + "px";
      stage.style.height = view.ih + "px";

      // Fit and center
      fitView();
    };

    img.onerror = () => {
      showWarn(warnEl, "PNG failed to load. Check the URL and that the object is public in R2.");
      clearPreview("Could not render PNG preview.");
    };

    img.src = bustUrl(pngUrl);

    stage.appendChild(img);
    viewport.appendChild(stage);

    // Wire interactions
    viewport.onpointerdown = (e) => {
      if (e.pointerType === "mouse" && e.button !== 0) return;
      viewport.setPointerCapture(e.pointerId);
      drag.active = true;
      drag.startX = e.clientX;
      drag.startY = e.clientY;
      drag.startTx = view.tx;
      drag.startTy = view.ty;
      viewport.classList.add("dragging");
    };

    viewport.onpointermove = (e) => {
      if (!drag.active) return;
      const dx = e.clientX - drag.startX;
      const dy = e.clientY - drag.startY;
      view.tx = drag.startTx + dx;
      view.ty = drag.startTy + dy;
      applyTransform();
    };

    viewport.onpointerup = (e) => {
      drag.active = false;
      viewport.classList.remove("dragging");
      try{ viewport.releasePointerCapture(e.pointerId); } catch {}
    };
    viewport.onpointercancel = () => {
      drag.active = false;
      viewport.classList.remove("dragging");
    };

    viewport.addEventListener("wheel", (e) => {
      e.preventDefault();
      const factor = e.deltaY > 0 ? 0.90 : 1.10;
      zoomAt(e.clientX, e.clientY, factor);
    }, { passive:false });

    const ro = new ResizeObserver(() => {
      // Re-fit on resize so it stays usable
      fitView();
    });
    ro.observe(viewport);

    return viewport;
  }

  function clearPreview(text){
    previewHost.innerHTML = "";
    previewHost.style.display = "flex";
    previewHost.style.alignItems = "center";
    previewHost.style.justifyContent = "center";
    previewHost.style.color = "#667";
    previewHost.style.padding = "18px";
    previewHost.textContent = text || "";
    viewportEl = null; stageEl = null; imgEl = null;
  }

  function setPreviewElement(el){
    previewHost.innerHTML = "";
    previewHost.style.display = "block";
    previewHost.style.color = "inherit";
    previewHost.style.padding = "0";
    previewHost.appendChild(el);
  }

  // =========================================================
  // Render active item
  // =========================================================
  function renderActive(it){
    hideWarn(warnEl); hideInfo();

    requestEditBtn.disabled = !it;

    if (!it){
      titleEl.textContent = "No item selected";
      metaEl.textContent = "";
      downloadDwgBtn.style.display = "none";
      openPngBtn.style.display = "none";
      renderKeywords(null);
      clearPreview("Select an item to preview its PNG.");
      return;
    }

    titleEl.textContent = it.name || "Untitled";

    const bits = [];
    if (it.updatedUtc) bits.push("Updated: " + safeDate(it.updatedUtc));
    if (it.createdUtc) bits.push("Created: " + safeDate(it.createdUtc));
    metaEl.textContent = bits.join(" • ");

    renderKeywords(it);

    // Buttons
    if (it.dwgUrl){
      downloadDwgBtn.style.display = "inline-block";
      downloadDwgBtn.onclick = () => {
        const a = document.createElement("a");
        a.href = bustUrl(it.dwgUrl);
        a.download = fileNameFromUrl(it.dwgUrl) || (it.name || "drawing") + ".dwg";
        document.body.appendChild(a);
        a.click();
        a.remove();
      };
    } else {
      downloadDwgBtn.style.display = "none";
    }

    if (it.pngUrl){
      openPngBtn.style.display = "inline-block";
      openPngBtn.onclick = () => window.open(bustUrl(it.pngUrl), "_blank", "noopener,noreferrer");
    } else {
      openPngBtn.style.display = "none";
    }

    // Preview
    if (!it.pngUrl){
      clearPreview("No PNG URL for this item.");
      showWarn(warnEl, "This entry has no pngUrl. Add one in library.json.");
      return;
    }

    const viewer = buildViewer(it.pngUrl, it.name);
    setPreviewElement(viewer);

    showInfo("Loaded preview.");
  }

  function safeDate(s){
    try{
      const d = new Date(s);
      if (isNaN(d.getTime())) return s;
      return d.toLocaleString();
    } catch { return s; }
  }

  function fileNameFromUrl(url){
    try{
      const u = new URL(url);
      const p = u.pathname.split("/").filter(Boolean).pop() || "";
      return decodeURIComponent(p);
    } catch {
      const p = (url || "").split("?")[0].split("#")[0].split("/").pop() || "";
      return p;
    }
  }

  // =========================================================
  // Mailto requests (Add/Edit)
  // =========================================================
  let modalMode = "add"; // "add" | "edit"

  function openModal(mode){
    modalMode = mode;
    hideWarn(warnEl); hideInfo();

    modalTitle.textContent = mode === "add" ? "Request Add" : "Request Edit";
    modalSub.textContent = mode === "add"
      ? "Fill what you can. If you don’t have URLs, describe what you’re sending and attach files manually."
      : "Pre-filled from the selected item. Change what you want. This creates a mailto draft.";

    // Pre-fill
    if (mode === "edit" && activeItem){
      reqItemName.value = activeItem.name || "";
      reqKeywords.value = (activeItem.keywords || []).join(", ");
      reqDwgUrl.value = activeItem.dwgUrl || "";
      reqPngUrl.value = activeItem.pngUrl || "";
      reqNotes.value = "Requested change:\n- \n\nReason:\n- \n";
    } else {
      reqItemName.value = "";
      reqKeywords.value = "";
      reqDwgUrl.value = "";
      reqPngUrl.value = "";
      reqNotes.value = "";
    }

    modalBackdrop.style.display = "flex";
  }

  function closeModal(){
    modalBackdrop.style.display = "none";
  }

  function buildMailto(){
    const who = (reqName.value || "").trim();
    const from = (reqEmail.value || "").trim();

    const name = (reqItemName.value || "").trim();
    const keywords = (reqKeywords.value || "").trim();
    const dwgUrl = (reqDwgUrl.value || "").trim();
    const pngUrl = (reqPngUrl.value || "").trim();
    const notes = (reqNotes.value || "").trim();

    const subject = encodeURIComponent(
      (modalMode === "add" ? "[DWG Library] Add Request: " : "[DWG Library] Edit Request: ") + (name || "(no name)")
    );

    const now = new Date().toISOString();

    const selected = activeItem ? {
      id: activeItem.id,
      name: activeItem.name,
      keywords: activeItem.keywords,
      dwgUrl: activeItem.dwgUrl,
      pngUrl: activeItem.pngUrl,
      updatedUtc: activeItem.updatedUtc,
      createdUtc: activeItem.createdUtc
    } : null;

    const bodyLines = [];
    bodyLines.push(`Request type: ${modalMode.toUpperCase()}`);
    bodyLines.push(`Time (UTC): ${now}`);
    if (who) bodyLines.push(`Requester: ${who}`);
    if (from) bodyLines.push(`Requester email: ${from}`);
    bodyLines.push("");
    bodyLines.push("=== Proposed entry ===");
    bodyLines.push(`Name: ${name}`);
    bodyLines.push(`Keywords: ${keywords}`);
    bodyLines.push(`DWG URL: ${dwgUrl}`);
    bodyLines.push(`PNG URL: ${pngUrl}`);
    bodyLines.push("");
    bodyLines.push("=== Notes ===");
    bodyLines.push(notes || "(none)");
    bodyLines.push("");
    if (modalMode === "edit"){
      bodyLines.push("=== Current entry (for reference) ===");
      bodyLines.push(JSON.stringify(selected, null, 2));
      bodyLines.push("");
    }
    bodyLines.push("If sending files instead of URLs: attach DWG + PNG to this email and provide desired keywords.");

    const body = encodeURIComponent(bodyLines.join("\n"));

    if (!ADMIN_EMAIL || ADMIN_EMAIL.includes("YOUR_ADMIN_EMAIL_HERE")){
      modalMsg.style.color = "var(--bad)";
      modalMsg.textContent = "Set ADMIN_EMAIL at the top of the file before using mailto.";
      return null;
    }

    return `mailto:${encodeURIComponent(ADMIN_EMAIL)}?subject=${subject}&body=${body}`;
  }

  // =========================================================
  // Events
  // =========================================================
  reloadBtn.addEventListener("click", async () => {
    try{
      await loadLibrary();
      showInfo("Reloaded library.json (fresh).");
    } catch (e){
      showWarn(warnLeft, String(e?.message || e));
      statusLine.textContent = "Load failed";
    }
  });

  searchBox.addEventListener("input", () => applyFilter(true));
  resetBtn.addEventListener("click", () => { searchBox.value=""; applyFilter(true); });

  zoomInBtn.addEventListener("click", () => {
    if (!viewportEl) return;
    const rect = viewportEl.getBoundingClientRect();
    zoomAt(rect.left + rect.width/2, rect.top + rect.height/2, 1.25);
  });
  zoomOutBtn.addEventListener("click", () => {
    if (!viewportEl) return;
    const rect = viewportEl.getBoundingClientRect();
    zoomAt(rect.left + rect.width/2, rect.top + rect.height/2, 0.8);
  });

  fitBtn.addEventListener("click", () => fitView());
  centerBtn.addEventListener("click", () => centerView());
  resetViewBtn.addEventListener("click", () => resetView());
  rotLeftBtn.addEventListener("click", () => setRotation(view.rotDeg - 90));
  rotRightBtn.addEventListener("click", () => setRotation(view.rotDeg + 90));

  requestAddBtn.addEventListener("click", () => openModal("add"));
  requestEditBtn.addEventListener("click", () => {
    if (!activeItem) return;
    openModal("edit");
  });

  closeModalBtn.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });

  emailBtn.addEventListener("click", () => {
    const u = buildMailto();
    if (!u) return;
    window.location.href = u;
    closeModal();
  });

  // =========================================================
  // Boot
  // =========================================================
  (async () => {
    try{
      clearPreview("Select an item to preview its PNG.");
      await loadLibrary();

      if (library.length === 0){
        showWarn(warnLeft, "library.json loaded but contained zero items.");
        statusLine.textContent = "Loaded 0 items";
        return;
      }

      // select first item by default
      selectItem(library[0].id);
    } catch (e){
      showWarn(warnLeft, "Failed to load library.json: " + String(e?.message || e));
      statusLine.textContent = "Load failed";
      clearPreview("Could not load library.json.");
    }
  })();
})();
</script>
</body>
</html>
